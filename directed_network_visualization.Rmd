---
title: "directed_network_visualization"
author: "Antoinette Fang"
date: "2025-06-02"
output: html_document
---

```{r}
library(igraph)
library(ggraph)
library(RColorBrewer)
library(cowplot)
library(dplyr)
library(purrr)
library(tidygraph)
```

```{r}
# Load significant pairs
significant_pairs <- read.csv("./pair stats/significant_pairs_directed_12m.csv") %>% rename(from = source, to = target)

edges<-significant_pairs %>% dplyr::select(from,to)

disease_code<-read.csv(file = "./diseaseCodes.csv")

# Load disease frequencies to help with hs_cancer_types mapping
disease_frequencies <- read.csv("./frequency tables/disease_frequencies_unstrat.csv")
```

```{r}
label_replacements <- c(
  "Keratoconjunctivitis sicca (KCS)" = "Keratoconjunctivitis sicca",
  "Hypertension (high blood pressure)" = "Hypertension",
  "Lameness (chronic or recurrent)" = "Lameness",
  "Bordatella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Bordetella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Cushing's disease (hyperadrenocorticism; excess adrenal function)" = "Cushing's disease",
  "Addison's disease (hypoadrenocorticism; low adrenal function)" = "Addison's disease",
  "Diabetes mellitus (common diabetes which causes high blood sugar)" = "Diabetes mellitus",
  "Penetrating wound (such as a stick)" = "Penetrating wound",
  "Head trauma due to any cause" = "Head trauma",
  "Chronic or recurrent cough" = "Chronic/recurrent cough",
  "Chronic or recurrent bronchitis" = "Chronic/recurrent bronchitis",
  "Tracheal stenosis (narrowing)" = "Tracheal stenosis",
  "Dental calculus (yellow build-up on teeth)" = "Dental calculus",
  "Gingivitis (red, puffy gums)" = "Gingivitis",
  "Retained deciduous (baby) teeth" = "Retained deciduous teeth",
  "Hearing loss (incompletely deaf)" = "Hearing loss",
  "Urinary tract infection (chronic or recurrent)" = "Urinary tract infection",
  "Urinary crystals or stones in bladder or urethra" = "Urinary crystals/stones",
  "Alopecia (hair loss)" = "Alopecia",
  "Atopic dermatitis (atopy)" = "Atopic dermatitis",
  "Pruritis (itchy skin)" = "Pruritis",
  "Chronic or recurrent hot spots" = "Chronic/recurrent hot spots",
  "Chronic or recurrent skin infections" = "Chronic/recurrent skin infections",
  "Food or medicine allergies that affect the skin" = "Food/medicine allergies affecting skin",
  "Food or medicine allergies" = "Food/medicine allergies",
  "Chronic or recurrent diarrhea" = "Chronic/recurrent diarrhea",
  "Chronic or recurrent vomiting" = "Chronic/recurrent vomiting",
  "Hemorrhagic gastroenteritis (HGE) or stress colitis (acute)" = "Hemorrhagic gastroenteritis or stress colitis",
  "Seborrhea or seborrheic dermatitis (greasy skin)" = "Seborrhea or seborrheic dermatitis"
)

# Define consistent palette for all networks
fixed_categories <- c(
  "Eye", "Ear/Nose/Throat", "Mouth/Dental/Oral", "Skin", "Respiratory",
  "Gastrointestinal", "Bone/Orthopedic", "Cardiac",
  "Infection/Parasites", "Trauma", "Kidney/Urinary", "Other"
)

# Set colors
category_palette <- setNames(
  RColorBrewer::brewer.pal(length(fixed_categories), "Paired"),
  fixed_categories
)

# Override the color for "Kidney/Urinary"
category_palette["Kidney/Urinary"] <- "black"
```


```{r}
# Build graph from filtered edge list
g <- graph_from_data_frame(edges, directed = TRUE)

# Drop any isolated vertices (if any left after edge filtering)
g <- delete_vertices(g, degree(g) == 0)

n_nodes <- gorder(g)   # Number of nodes
n_edges <- gsize(g)    # Number of edges

# Match by code and assign phenotype to vertex attribute
# Add disease name
V(g)$disease_name <- disease_frequencies$Disease.Name[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]

# Add category
V(g)$category <- disease_frequencies$Disease.Category[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]

# Add frequency
V(g)$frequency <- disease_frequencies$frequency[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]

# Count category frequencies
category_counts <- table(V(g)$category)
keep_categories <- names(category_counts[category_counts > 3])

# Simplify display category
V(g)$display_category <- ifelse(
  V(g)$category %in% keep_categories,
  V(g)$category,
  "Other"
)

V(g)$disease_name <- dplyr::recode(
  V(g)$disease_name,
  !!!label_replacements
)

# Only label specific nodes
nodes_to_label <- c("604", "605", "405", "407", "411", "423", "104", "109", "412", "313", "305", "304", "307", "311", "408", "607", "406", "914", "915", "712", "202", "1110", "1113", "1106", "1112", "1307", "102", "421", "602", "414", "916")  # Add more node IDs as needed

V(g)$label <- ifelse(
  V(g)$name %in% nodes_to_label,
  V(g)$disease_name,
  NA
)

# Generate edge category labels
edge_list <- as_edgelist(g, names = FALSE)

edge_categories <- apply(edge_list, 1, function(edge) {
  cat1 <- V(g)$display_category[edge[1]]
  cat2 <- V(g)$display_category[edge[2]]

  if (!is.na(cat1) && !is.na(cat2) && cat1 == cat2) {
    return(cat1)
  } else {
    return("Cross-category")
  }
})

E(g)$edge_category <- edge_categories
# Generate edge category labels
edge_list <- as_edgelist(g, names = FALSE)

edge_categories <- apply(edge_list, 1, function(edge) {
  cat1 <- V(g)$display_category[edge[1]]
  cat2 <- V(g)$display_category[edge[2]]

  if (!is.na(cat1) && !is.na(cat2) && cat1 == cat2) {
    return(cat1)
  } else {
    return("Cross-category")
  }
})

E(g)$edge_category <- edge_categories

# Node category palette
# Use predefined fixed categories and palette
node_palette <- category_palette


# Edge palette (add grey for cross-category)
edge_palette <- c(category_palette, "Cross-category" = "grey38")


# Prepare tidygraph with attributes
tg <- as_tbl_graph(g) |>
  mutate(
    disease_name = V(g)$disease_name,
    frequency = V(g)$frequency,
    display_category = V(g)$display_category
  ) |>
  activate(edges) |>
  mutate(edge_category = E(g)$edge_category)

# Generate layout
layout_directed <- create_layout(tg, layout = "fr")

p_directed <- ggraph(layout_directed) +
  geom_edge_link(
    aes(color = edge_category),
    alpha = 0.5,
    arrow = arrow(length = unit(3, "mm")),
    end_cap = circle(3, "mm")
  ) +
  geom_node_point(
    aes(size = frequency, color = display_category),
    alpha = 0.9
  ) +
  geom_node_label(
  aes(label = label),
  label.size = 0.3,                    # thin border
  label.r = unit(0.15, "lines"),       # rounded corners
  fill = alpha("white", 0.7),          # translucent background
  color = "black",                     # text color
  fontface = "plain",
  size = 3,
  repel = TRUE,
  na.rm = TRUE
) +
  scale_edge_color_manual(values = edge_palette, name = "Edge Category") +
  scale_color_manual(values = node_palette, name = "Node Category") +
  scale_size_continuous(name = "Frequency", range = c(2, 7)) +
  theme_void() 
  # ggtitle("12 month") +
  # annotate(
  #   "text",
  #   x = Inf, y = -Inf,
  #   label = paste("Nodes:", n_nodes, "\nEdges:", n_edges),
  #   hjust = 1.1, vjust = -0.5,
  #   size = 3.5
  # )


print(p_directed)

# Save plot
ggsave(
  filename = "./network images/directed_12m.tiff",
  plot = p_directed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in",
  compression = "lzw"
)

ggsave(
  filename = "./network images/directed_12m.png",
  plot = p_directed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)
```

