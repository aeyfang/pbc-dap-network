---
title: "directed_network_visualization"
author: "Antoinette Fang"
date: "2025-06-02"
output: html_document
---

```{r}
library(igraph)
library(ggraph)
library(RColorBrewer)
library(cowplot)
library(dplyr)
library(purrr)
library(tidygraph)
```

```{r}
# Load significant pairs
significant_pairs <- read.csv("./pair stats/significant_pairs_directed_12m.csv") %>% rename(from = source, to = target)

edges<-significant_pairs %>% dplyr::select(from,to)

disease_code<-read.csv(file = "./diseaseCodes.csv")

# Load disease frequencies to help with hs_cancer_types mapping
disease_frequencies <- read.csv("./frequency tables/disease_frequencies_unstrat.csv")
```

```{r}
label_replacements <- c(
  "Keratoconjunctivitis sicca (KCS)" = "Keratoconjunctivitis sicca",
  "Hypertension (high blood pressure)" = "Hypertension",
  "Lameness (chronic or recurrent)" = "Lameness",
  "Bordatella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Bordetella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Cushing's disease (hyperadrenocorticism; excess adrenal function)" = "Cushing's disease",
  "Addison's disease (hypoadrenocorticism; low adrenal function)" = "Addison's disease",
  "Diabetes mellitus (common diabetes which causes high blood sugar)" = "Diabetes mellitus",
  "Penetrating wound (such as a stick)" = "Penetrating wound",
  "Head trauma due to any cause" = "Head trauma",
  "Chronic or recurrent cough" = "Chronic/recurrent cough",
  "Chronic or recurrent bronchitis" = "Chronic/recurrent bronchitis",
  "Tracheal stenosis (narrowing)" = "Tracheal stenosis",
  "Dental calculus (yellow build-up on teeth)" = "Dental calculus",
  "Gingivitis (red, puffy gums)" = "Gingivitis",
  "Retained deciduous (baby) teeth" = "Retained deciduous teeth",
  "Hearing loss (incompletely deaf)" = "Hearing loss",
  "Urinary tract infection (chronic or recurrent)" = "Urinary tract infection",
  "Urinary crystals or stones in bladder or urethra" = "Urinary crystals/stones",
  "Alopecia (hair loss)" = "Alopecia",
  "Atopic dermatitis (atopy)" = "Atopic dermatitis",
  "Pruritis (itchy skin)" = "Pruritis",
  "Chronic or recurrent hot spots" = "Chronic/recurrent hot spots",
  "Chronic or recurrent skin infections" = "Chronic/recurrent skin infections",
  "Food or medicine allergies that affect the skin" = "Skin food/medicine allergies affecting skin",
  "Food or medicine allergies" = "Gastrointestinal food/medicine allergies",
  "Chronic or recurrent diarrhea" = "Chronic/recurrent diarrhea",
  "Chronic or recurrent vomiting" = "Chronic/recurrent vomiting",
  "Hemorrhagic gastroenteritis (HGE) or stress colitis (acute)" = "Hemorrhagic gastroenteritis or stress colitis",
  "Seborrhea or seborrheic dermatitis (greasy skin)" = "Seborrhea or seborrheic dermatitis"
)

# Define consistent palette for all networks
fixed_categories <- c(
  "Eye", "Ear/Nose/Throat", "Mouth/Dental/Oral", "Skin", "Respiratory",
  "Gastrointestinal", "Bone/Orthopedic", "Cardiac",
  "Infection/Parasites", "Trauma", "Kidney/Urinary", "Other"
)

# Set colors
category_palette <- setNames(
  RColorBrewer::brewer.pal(length(fixed_categories), "Paired"),
  fixed_categories
)

# Override the color for "Kidney/Urinary"
category_palette["Kidney/Urinary"] <- "black"

```

```{r}
# Build graph
g <- graph_from_data_frame(edges, directed = TRUE)
g <- delete_vertices(g, degree(g) == 0)

V(g)$disease_name <- disease_frequencies$Disease.Name[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]
V(g)$category <- disease_frequencies$Disease.Category[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]
V(g)$frequency <- disease_frequencies$frequency[
  match(V(g)$name, disease_frequencies$Numerical.Codes)
]

category_counts <- table(V(g)$category)
keep_categories <- names(category_counts[category_counts > 3])

V(g)$display_category <- ifelse(
  V(g)$category %in% keep_categories,
  V(g)$category,
  "Other"
)

V(g)$disease_name <- dplyr::recode(
  V(g)$disease_name,
  !!!label_replacements
)

# Generate edge categories
edge_list <- as_edgelist(g, names = FALSE)

edge_categories <- apply(edge_list, 1, function(edge) {
  cat1 <- V(g)$display_category[edge[1]]
  cat2 <- V(g)$display_category[edge[2]]
  if (!is.na(cat1) && !is.na(cat2) && cat1 == cat2) {
    return(cat1)
  } else {
    return("Cross-category")
  }
})
E(g)$edge_category <- edge_categories

# Save original graph before collapsing
g_uncollapsed <- g

# Function to collapse nodes by category
collapse_category <- function(g, category_name, agg_id) {
  nodes <- V(g)[display_category == category_name]$name
  g <- add_vertices(g, 1,
    name = agg_id,
    disease_name = paste(category_name, "(Aggregate)"),
    category = category_name,
    display_category = category_name,
    frequency = sum(V(g)$frequency[V(g)$name %in% nodes], na.rm = TRUE),
    label = NA
  )
  for (node in nodes) {
    incoming <- incident(g, node, mode = "in")
    for (e in incoming) {
      from <- ends(g, e)[1]
      if (from != node) {
        g <- add_edges(g, c(from, agg_id), attr = list(edge_category = E(g)[e]$edge_category))
      }
    }
    outgoing <- incident(g, node, mode = "out")
    for (e in outgoing) {
      to <- ends(g, e)[2]
      if (to != node) {
        g <- add_edges(g, c(agg_id, to), attr = list(edge_category = E(g)[e]$edge_category))
      }
    }
  }
  g <- delete_vertices(g, nodes)
  return(g)
}

# Collapse "Skin" and "Infection/Parasites"
g <- collapse_category(g, "Skin", "skin_agg")
g <- collapse_category(g, "Infection/Parasites", "infect_agg")

# Set all labels initially
V(g)$label <- V(g)$disease_name

# Remove labels for aggregate nodes and their neighbors
agg_nodes <- c("skin_agg", "infect_agg")
agg_neighbors <- unique(unlist(neighborhood(g, order = 1, nodes = agg_nodes, mode = "all")))
agg_neighbor_names <- V(g)$name[agg_neighbors]
V(g)$label <- ifelse(V(g)$name %in% c(agg_nodes, agg_neighbor_names), NA, V(g)$label)

# Mark aggregate nodes
V(g)$is_aggregate <- V(g)$name %in% c("skin_agg", "infect_agg")

# Prepare palettes
node_palette <- category_palette
edge_palette <- c(category_palette, "Cross-category" = "grey38")

# Convert to tidygraph
tg <- as_tbl_graph(g) |>
  mutate(
    disease_name = V(g)$disease_name,
    frequency = V(g)$frequency,
    display_category = V(g)$display_category,
    is_aggregate = V(g)$is_aggregate
  ) |>
  activate(edges) |>
  mutate(edge_category = E(g)$edge_category)

# Create layout
layout_directed <- create_layout(tg, layout = "fr")

p_directed <- ggraph(layout_directed) +
  geom_edge_link(
    aes(color = edge_category),
    alpha = 0.5,
    arrow = arrow(length = unit(3, "mm")),
    end_cap = circle(3, "mm")
  ) +
  geom_node_point(
  aes(
    size = frequency,
    color = display_category,
    shape = is_aggregate
  ),
  alpha = 0.9,
  stroke = 1.5  # thickness of border
) +
  geom_node_label(
    aes(label = label),
    label.size = 0.3,
    label.r = unit(0.15, "lines"),
    fill = alpha("white", 0.7),
    color = "black",
    fontface = "plain",
    size = 3,
    repel = TRUE,
    na.rm = TRUE
  ) +
  scale_edge_color_manual(values = edge_palette, name = "Edge Category") +
  scale_color_manual(values = node_palette, name = "Node Category") +
  scale_size_continuous(
    name = "Frequency",
    range = c(2, 7),
    breaks = c(1000, 5000, 10000, 20000)
  ) +
  scale_shape_manual(
  values = c(`TRUE` = 21, `FALSE` = 16),
  name = "Node Type",
  labels = c("FALSE" = "Individual", "TRUE" = "Aggregate")
) +
  theme_void()

print(p_directed)

# Save plots
ggsave(
  filename = "./network images/directed_12m.tiff",
  plot = p_directed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in",
  compression = "lzw"
)

ggsave(
  filename = "./network images/directed_12m.png",
  plot = p_directed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)

```

```{r subplot of skin and infection/parasites}
# Categories we want to analyze in detail
detailed_categories <- c("Skin", "Infection/Parasites")

# Get the names of all nodes in those categories from the uncollapsed graph
core_nodes <- V(g_uncollapsed)[
  display_category %in% detailed_categories
]$name

# Get 1st-degree neighbors (in or out) of those nodes
neighbor_indices <- neighborhood(g_uncollapsed, order = 1, nodes = core_nodes, mode = "all")
neighbor_names <- unique(unlist(lapply(neighbor_indices, \(x) V(g_uncollapsed)$name[x])))

# Combine core + neighbors
detailed_subgraph_nodes <- unique(c(core_nodes, neighbor_names))

# Build subgraph from these nodes
subgraph_detailed <- induced_subgraph(g_uncollapsed, vids = detailed_subgraph_nodes)

# Convert to tidygraph
tg_detailed <- as_tbl_graph(subgraph_detailed) |>
  mutate(
    disease_name = V(subgraph_detailed)$disease_name,
    frequency = V(subgraph_detailed)$frequency,
    display_category = V(subgraph_detailed)$display_category,
    is_aggregate = FALSE  # all are unaggregated
  ) |>
  activate(edges) |>
  mutate(edge_category = E(subgraph_detailed)$edge_category)

# Create layout
layout_detailed <- create_layout(tg_detailed, layout = "fr")

# Plot
p_detailed <- ggraph(layout_detailed) +
  geom_edge_link(
    aes(color = edge_category),
    alpha = 0.5,
    arrow = arrow(length = unit(3, "mm")),
    end_cap = circle(3, "mm")
  ) +
  geom_node_point(
    aes(
      size = frequency,
      color = display_category,
      shape = is_aggregate
    ),
    alpha = 0.9,
    stroke = 1.5
  ) +
  geom_node_label(
    aes(label = disease_name),
    label.size = 0.3,
    label.r = unit(0.15, "lines"),
    fill = alpha("white", 0.7),
    color = "black",
    fontface = "plain",
    size = 3,
    repel = TRUE,
    na.rm = TRUE
  ) +
  scale_edge_color_manual(values = edge_palette, name = "Edge Category") +
  scale_color_manual(values = node_palette, name = "Node Category") +
  scale_size_continuous(
    name = "Frequency",
    range = c(2, 7),
    breaks = c(1000, 5000, 10000, 20000)
  ) +
  scale_shape_manual(
    values = c(`TRUE` = 21, `FALSE` = 16),
    name = "Node Type",
    labels = c("FALSE" = "Individual", "TRUE" = "Aggregate")
  ) +
  theme_void()

print(p_detailed)

# Save image
ggsave(
  filename = "./network images/detailed_skin_infection_plus_neighbors.tiff",
  plot = p_detailed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in",
  compression = "lzw"
)

ggsave(
  filename = "./network images/detailed_skin_infection_plus_neighbors.png",
  plot = p_detailed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)
```
```{r}
p_directed_clean <- p_directed + theme(legend.position = "none",
                                       plot.margin = margin(b=20)) 
p_detailed_clean <- p_detailed + theme(legend.position = "none",
                                       plot.margin = margin(t=20))
shared_legend <- cowplot::get_legend(
  p_directed + theme(legend.position = "right",
                     legend.title = element_text(size = 16), 
                     legend.text = element_text(size = 14))
)

# Combine plots vertically without legend first
stacked <- cowplot::plot_grid(
  p_directed_clean,
  p_detailed_clean,
  ncol = 1,
  rel_heights = c(1, 1)
)

# Add a) and b) labels manually to top-left corners
labeled_stacked <- cowplot::ggdraw(stacked) +
  cowplot::draw_plot_label(
    label = c("a)", "b)"),
    x = c(0.01, 0.01),
    y = c(0.99, 0.49),
    hjust = 0,
    vjust = 1,
    fontface = "bold",
    size = 14
  )

combined_plot <- cowplot::plot_grid(
  labeled_stacked,
  shared_legend,
  ncol = 2,
  rel_widths = c(4, 1)
)


combined_plot

ggsave(
  filename = "./network images/combined_directed.tiff",
  plot = combined_plot,
  dpi = 600,
  width = 12,
  height = 14,
  units = "in",
  compression = "lzw"
)

ggsave(
  filename = "./network images/combined_labeled.png",
  plot = combined_plot,
  dpi = 600,
  width = 12,
  height = 14,
  units = "in"
)


```

