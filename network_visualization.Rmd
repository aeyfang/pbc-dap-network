---
title: "network_visualization"
author: "Antoinette Fang"
date: "2025-04-29"
output: html_document
---



```{r}
library(igraph)
library(ggraph)
library(RColorBrewer)
# display.brewer.all()
library(cowplot)
library(dplyr)
library(purrr)
library(tidygraph)
theme_set(theme_cowplot())
edge_percent <- 1

```

```{r}
# Load significant pairs
significant_pairs <- read.csv("./pair stats/significant_pairs_unstrat.csv")

disease_code<-read.csv(file = "./diseaseCodes.csv")

# Load disease frequencies to help with hs_cancer_types mapping
disease_frequencies <- read.csv("./frequency tables/disease_frequencies_unstrat.csv")

# Define a cleaning function for disease names
clean_disease_name <- function(name) {
  if (startsWith(name, "condition_")) {
    return(sub("^condition_", "", name))
  } else if (startsWith(name, "hs_cancer_types_")) {
    code <- disease_frequencies %>%
      filter(Code.from.DAP.data == name) %>%
      pull(Numerical.Codes)
    return(if (length(code) == 0) name else as.character(code))
  }
  return(name)
}

# Apply cleaning function
significant_pairs <- significant_pairs %>%
  mutate(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  ) %>%
  mutate(
    Disease1 = as.integer(Disease1),
    Disease2 = as.integer(Disease2)
  ) %>%
  filter(!is.na(Disease1) & !is.na(Disease2)) %>%
  filter(
    !(Disease1 %% 100 %in% c(98, 99) |
      Disease2 %% 100 %in% c(98, 99) |
      Disease1 == 719 |
      Disease2 == 719)
  )

```

```{r}
formatted_significant_pairs <- significant_pairs %>%
  transmute(
    Disease1 = Disease1,
    Disease2 = Disease2,
    weight = AdjustedPValue
  )

class(formatted_significant_pairs$Disease1)
```


```{r}
most.prevalent.category <- c('Brain/Neurologic', 
                             'Cancer',
                             'Kidney/Urinary',
                             'Cardiac', 
                             'Gastrointestinal',
                             'Ear/Nose/Throat',
                             'Skin','Eye','Liver/Pancreas'
                              )

# Get enough colors (9 prevalent + 1 Other + 1 Cross-category)
all.colors <- brewer.pal(length(most.prevalent.category) + 2, "Paired")

# Assign category labels
categoryLabels <- c(sort(most.prevalent.category), "Other", "Cross-category")
names(all.colors) <- categoryLabels
```

```{r}
# 1. Build early_graph
early_graph <- graph_from_data_frame(formatted_significant_pairs, directed = FALSE)

# 2. Attach consolidated category
modules <- disease_code %>%
  mutate(
    category = Disease.Category,
    code = Numerical.Codes,
    consolidated.category = ifelse(category %in% most.prevalent.category, category, "Other")
  ) %>%
  select(code, category, consolidated.category)

nodes_info <- data.frame(code = as.integer(V(early_graph)$name)) %>%
  left_join(modules, by = "code")

V(early_graph)$consolidated.category <- nodes_info$consolidated.category

# 3. Identify singleton nodes
is_singleton <- function(v) {
  neighbors_v <- neighbors(early_graph, v)
  if (length(neighbors_v) == 0) {
    return(TRUE)
  }
  own_category <- V(early_graph)$consolidated.category[v]
  neighbor_categories <- V(early_graph)$consolidated.category[neighbors_v]
  all(neighbor_categories != own_category)
}

singleton_flags <- sapply(V(early_graph), is_singleton)

singleton_node_codes <- as.integer(V(early_graph)$name[singleton_flags])


```

```{r}
disease_code_for_collapsing_groups <- disease_code %>%
  mutate(module = Numerical.Codes) %>%
  
  mutate(module = ifelse(module %in% seq(101, 198) & !(module %in% singleton_node_codes), 1, module)) %>%  # Eye
  mutate(module = ifelse(module %in% seq(301, 398) & !(module %in% singleton_node_codes), 3, module)) %>%  # Mouth/Dental/Oral
  mutate(module = ifelse(module %in% seq(401, 497) & !(module %in% singleton_node_codes), 4, module)) %>%  # Skin
  mutate(module = ifelse(module %in% seq(501, 598) & !(module %in% singleton_node_codes), 5, module)) %>%  # Cardiac
  mutate(module = ifelse(module %in% seq(601, 698) & !(module %in% singleton_node_codes), 6, module)) %>%  # Respiratory
  mutate(module = ifelse(module %in% seq(701, 798) & !(module %in% singleton_node_codes), 7, module)) %>%  # Gastrointestinal
  mutate(module = ifelse(module %in% seq(1101, 1198) & !(module %in% singleton_node_codes), 11, module)) %>%  # Bone/Orthopedic
  mutate(module = ifelse(module %in% seq(1301, 1398) & !(module %in% singleton_node_codes), 13, module)) %>%  # Endocrine
  mutate(module = ifelse(module %in% seq(1601, 1697) & !(module %in% singleton_node_codes), 16, module)) %>%  # Infection/Parasites
  mutate(module = ifelse(module %in% seq(1701, 1798) & !(module %in% singleton_node_codes), 17, module)) %>%  # Toxin Consumption
  mutate(module = ifelse(module %in% seq(1801, 1897) & !(module %in% singleton_node_codes), 18, module)) %>%  # Trauma
  
  mutate(
    category = Disease.Category,
    code = Numerical.Codes,
    consolidated.category = ifelse(category %in% most.prevalent.category, category, "Other")
  ) %>%
  select(code, category, consolidated.category, module)

```

```{r}
# Contract the graph
gn <- contract(graph, V(graph)$module, vertex.attr.comb=list(
  name = 'first',
  category = 'first',
  prevalence = 'sum',
  hub = 'first',
  module = 'ignore',
  consolidated.category = 'first'
))

# Dynamically detect number of collapsed groups
group_module_ids <- c(1, 3, 4, 5, 6, 7, 11, 13, 16, 17, 18)

actual_no_collapsed <- sum(as.integer(V(gn)$name) %in% group_module_ids)

# Assign node types
V(gn)$type <- c(
  rep('group', actual_no_collapsed),
  rep('single', length(V(gn)$name) - actual_no_collapsed)
)
```


```{r}
# Build the graph object
graph <- formatted_significant_pairs %>%
  graph_from_data_frame(directed = FALSE) %>%
  as_tbl_graph(directed = FALSE) %>%
  activate(nodes)

# Attach attributes to nodes
nodes.stat <- data.frame(code = as.integer(V(graph)$name)) %>%
  left_join(disease_code_for_collapsing_groups, by = "code") %>%
  left_join(
    disease_frequencies %>%
      mutate(code = Numerical.Codes) %>%
      select(code, frequency, Disease.Name),
    by = "code"
  )

V(graph)$consolidated.category <- nodes.stat$consolidated.category
V(graph)$category <- nodes.stat$category
V(graph)$module <- as.numeric(as.factor(nodes.stat$module))
V(graph)$prevalence <- nodes.stat$frequency

# ðŸ”¥ Create hub labels
V(graph)$hub <- ifelse(
  V(graph)$category %in% most.prevalent.category,
  as.character(V(graph)$category),         # Group nodes will be labeled by category
  as.character(nodes.stat$Disease.Name)     # Singletons will be labeled by specific disease name
)

V(graph)$module[is.na(V(graph)$module)] <- 999

# Contract the graph
gn <- contract(graph, V(graph)$module, vertex.attr.comb = list(
  name = 'first',
  category = 'first',
  prevalence = 'sum',
  hub = 'first',
  module = 'ignore',
  consolidated.category = 'first'
))

# Assign node types
group_module_ids <- c(1, 3, 4, 5, 6, 7, 11, 13, 16, 17, 18)
actual_no_collapsed <- sum(as.integer(V(gn)$name) %in% group_module_ids)

V(gn)$type <- c(
  rep('group', actual_no_collapsed),
  rep('single', length(V(gn)$name) - actual_no_collapsed)
)

edge_cats <- ends(gn, es = E(gn), names = FALSE)

# UNLIST to fix list-type error
category1 <- unlist(V(gn)$consolidated.category[edge_cats[,1]])
category2 <- unlist(V(gn)$consolidated.category[edge_cats[,2]])

E(gn)$edge_color <- ifelse(
  category1 == category2,
  as.character(category1),
  "Cross-category"
)


p3 <- ggraph(gn, layout = layout_nicely(gn)) + 
  geom_edge_link(aes(color = edge_color), alpha = 0.5) +
  scale_edge_colour_manual(values = all.colors) +
  geom_node_point(aes(color = consolidated.category, size = prevalence, shape = type)) +
  scale_colour_manual(values = all.colors) +
  scale_shape_manual(values = c("group" = 17, "single" = 16)) +
  geom_node_label(aes(label = hub), repel = TRUE, max.overlaps = Inf, fontface = 'italic') +
  ggtitle("Contracted Disease Network (layout_nicely)") +
  theme_minimal()

p3


save_plot(p3, filename = "./DAP_network_figures_tables/unstrat_network.png", base_height = 7)

```

