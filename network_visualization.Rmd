---
title: "network_visualization"
author: "Antoinette Fang"
date: "2025-04-29"
output: html_document
---

```{r}
library(igraph)
library(ggraph)
library(RColorBrewer)
# display.brewer.all()
library(cowplot)
library(dplyr)
library(purrr)
theme_set(theme_cowplot())
edge_percent <- 1


disease_frequencies <- read.csv(paste0("./frequency tables/disease_frequencies_", 'unstrat', ".csv"))
disease_code<-read.csv(file = "./diseaseCodes.csv")

clean_disease_name <- function(name) {
  if(startsWith(name, "condition_")) {
    return(sub("^condition_", "", name))
  } else if(startsWith(name, "hs_cancer_types_")) {
    code <- disease_frequencies %>%
      filter(Code.from.DAP.data == name) %>%
      pull(Numerical.Codes)
    return(if(length(code) == 0) name else as.character(code))
  }
  return(name)
}
significant_pairs <- read.csv("./pair stats/significant_pairs_unstrat.csv")
formatted_significant_pairs <- significant_pairs %>%
  transmute(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  ) 

class(formatted_significant_pairs$Disease1)

most.prevalent.category <- c('Brain/Neurologic', 
                             'Cancer',
                             'Kidney/Urinary',
                             'Cardiac', 
                             'Gastrointestinal',
                             'Ear/Nose/Throat',
                             'Skin','Eye','Liver/Pancreas'
                              )
# all.colors <- brewer.pal(8,'Dark2')
all.colors <- brewer.pal(length(most.prevalent.category)+2, 'Paired')
categoryLabels <- c(sort(most.prevalent.category), "Other")
names(all.colors) <- c(categoryLabels,'Yellow')

#head(disease_code[disease_code$Disease.Category=='Respiratory',])

# collapse groups of diseases by category (may exclude the Other within each category as they sometimes behave differently)
# the variable `module` will be used as a mapping to contract the graph
disease_code_for_collapsing_groups <- disease_code %>%
  mutate(module = Numerical.Codes) %>%
  mutate(module = ifelse(module %in% seq(101,198), 1, module)) %>% # Eye
  mutate(module = ifelse(module %in% seq(301,398), 3, module)) %>% # Mouth/Dental/Oral
  mutate(module = ifelse(module %in% seq(401,497), 4, module)) %>% # Skin
  mutate(module = ifelse(module %in% seq(501,598), 5, module)) %>% # Cardiac
  mutate(module = ifelse(module %in% seq(601,698), 6, module)) %>% # Respiratory
  mutate(module = ifelse(module %in% seq(701,798), 7, module)) %>% # Gastrointestinal
  mutate(module = ifelse(module %in% seq(1101,1198), 11, module)) %>% # Bone/Orthopedic
  mutate(module = ifelse(module %in% seq(1301,1398), 13, module)) %>% # Endocrine
  mutate(module = ifelse(module %in% seq(1601,1697), 16, module)) %>% # Infection/Parasites
  mutate(module = ifelse(module %in% seq(1701,1798), 17, module)) %>% # Toxin Consumption
  mutate(module = ifelse(module %in% seq(1801,1897), 18, module)) # Trauma
  
no.collapsed <- 11
modules <- disease_code_for_collapsing_groups %>%
  mutate('category' = Disease.Category) %>%
  mutate('code' = Numerical.Codes) %>%
  mutate('X' = NULL) %>%
  mutate("Numerical.Codes" = NULL) %>%
  mutate("Disease.Category" = NULL) %>%
  mutate('consolidated.category' = ifelse(category %in% most.prevalent.category, category, 'Other'))

# g <- graph_from_data_frame(formatted_significant_pairs, directed = F)
# g
# nodes.stat <- data.frame(code=as.integer(V(g)$name)) %>% 
#   left_join(modules, by = 'code')
# V(g)$module <- as.numeric(as.factor(nodes.stat$module))
# V(g)$category <- nodes.stat$consolidated.category
# gn <- contract(g, V(g)$module, vertex.attr.comb=toString)
# V(gn)$category[1:5] <- c('Skin','Other',"Bone/Orthopedic",'Trauma','Infection/Parasites')
# p <- ggraph(gn) + 
#   geom_edge_link(aes(alpha=0.5), color='grey') + 
#   geom_node_point(aes(color=category))  +
#   scale_colour_manual(values=all.colors) 
# p

# get the hub diseases from g
# This is just one way of creating labels for a subset of the nodes. We could 
#  also only label diseases for which we would like to highlight, or based on overall prevalence
# hub_diseases <- V(g)$name[degree(g) >= 10]

## a simple graph ----
graph <- formatted_significant_pairs %>% 
  igraph::graph_from_data_frame(directed = F) %>% 
  tidygraph::as_tbl_graph(directed=FALSE) %>% 
  tidygraph::activate(nodes) 

nodes.stat <- data.frame(code=as.integer(V(graph)$name)) %>% 
  left_join(modules, by = 'code') %>%
  left_join(disease_frequencies %>%
              mutate(code=Numerical.Codes) %>%
              mutate(Disease.Category = NULL),
            by = 'code')

V(graph)$category <- nodes.stat$consolidated.category
V(graph)$prevalence <- nodes.stat$frequency

# make the plot with gggraph
p <- ggraph(graph) + 
  geom_edge_link(aes(alpha=0.5), color='grey') + 
  geom_node_point(aes(color=category)) +
  geom_node_label(aes(label=name), repel=TRUE, max.overlaps=Inf, fontface='italic') 
p


## update figure to be more informative ----
formatted_significant_pairs <- significant_pairs %>%
  transmute(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name),
    weight = AdjustedPValue
  ) %>%
  mutate(Disease1 = as.integer(Disease1)) %>%
  mutate(Disease2 = as.integer(Disease2))

# get the module & color info for gene1
temp1 <- dplyr::inner_join(
  formatted_significant_pairs,
  modules %>% 
    dplyr::select(c(code, consolidated.category)) %>% 
    dplyr::rename(Disease1 = code, category1=consolidated.category),
  by = 'Disease1'
) %>% dplyr::select(category1)

# get the module & color info for gene2
temp2 <- dplyr::inner_join(
  formatted_significant_pairs,
  modules %>% 
    dplyr::select(c(code, consolidated.category)) %>% 
    dplyr::rename(Disease2 = code, category2=consolidated.category),
  by = 'Disease2'
) %>% dplyr::select(category2)

# add the module & color info 
formatted_significant_pairs <- cbind(formatted_significant_pairs, temp1, temp2)

# set the edge color to the module's color if they are the two genes are in the same module 
formatted_significant_pairs$edge_color <- ifelse(
  formatted_significant_pairs$category1 == formatted_significant_pairs$category2, 
  as.character(formatted_significant_pairs$category1),
  'Yellow'
)

# keep this network before subsetting
formatted_significant_pairs_full <- formatted_significant_pairs 

# keep the top edge_percent of edges 
formatted_significant_pairs <- formatted_significant_pairs_full %>% 
  # subset(category1!=category2) %>%
  dplyr::slice_min(
    order_by = weight, 
    n = round(nrow(formatted_significant_pairs)*edge_percent)
  )

# make the graph object with tidygraph
graph <- formatted_significant_pairs %>% 
  igraph::graph_from_data_frame() %>%
  tidygraph::as_tbl_graph(directed=FALSE) %>% 
  tidygraph::activate(nodes)

# add the module name to the graph:
nodes.stat <- data.frame(code=as.integer(V(graph)$name)) %>% 
  left_join(modules, by = 'code') %>%
  left_join(disease_frequencies %>%
              mutate(code=Numerical.Codes) %>%
              mutate(Disease.Category = NULL),
            by = 'code')

V(graph)$consolidated.category <- nodes.stat$consolidated.category
V(graph)$category <- nodes.stat$category
V(graph)$prevalence <- nodes.stat$frequency
V(graph)$hub <- ifelse(V(graph)$category %in% c('Skin','Eye','Gastrointestinal','Cardiac',
                                                'Mouth/Dental/Oral','Respiratory','Bone/Orthopedic',
                                                'Infection/Parasites','Trauma','Toxin Consumption',
                                                'Endocrine'), nodes.stat$category, nodes.stat$Disease.Name.x)
V(graph)$module <- as.numeric(as.factor(nodes.stat$module))
# E(graph)$weight <- E(graph)$weight + 1.502132e-12

p2 <- ggraph(graph, layout=layout_nicely(graph)) + 
  geom_edge_link(aes(color=edge_color)) + 
  scale_edge_colour_manual(values=all.colors) +
  geom_node_point(aes(color=consolidated.category, size=prevalence)) +
  scale_colour_manual(values=all.colors) +
  # geom_node_label(aes(label=hub), repel=TRUE, max.overlaps=Inf, fontface='italic') +
  ggtitle("layout_nicely()") 

p2


gn <- contract(graph, V(graph)$module, vertex.attr.comb=list(
  # name = toString,
  name = 'first',
  category = 'first',
  prevalence = 'sum',
  hub = 'first',
  module = 'ignore',
  consolidated.category = 'first'
))

V(gn)$type <- c(rep('group',no.collapsed), rep('single',length(V(gn)$name)-no.collapsed))
my.shapes <- c(17,16)
names(my.shapes) <- unique(V(gn)$type)
# V(gn)$hub <- ifelse(V(gn)$name %in% hub_diseases, V(gn)$name, "")

p3 <- ggraph(gn, layout=layout_nicely(gn)) + 
  geom_edge_link(aes(color=edge_color)) + 
  scale_edge_colour_manual(values=all.colors) +
  geom_node_point(aes(color=consolidated.category, size=prevalence, shape = type)) +
  scale_colour_manual(values=all.colors) +
  scale_shape_manual(values = my.shapes) +
  geom_node_label(aes(label=hub), repel=TRUE, max.overlaps=Inf, fontface='italic') +
  ggtitle("layout_nicely()") 
# NoLegend()

p3

save_plot(p3, file="./DAP_network_figures_tables/unstrat_network.png", base_height = 7)

```










