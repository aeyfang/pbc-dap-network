---
title: "network_visualization"
author: "Antoinette Fang"
date: "2025-04-29"
output: html_document
---


```{r}
library(igraph)
library(ggraph)
library(RColorBrewer)
library(cowplot)
library(dplyr)
library(purrr)
library(tidygraph)
library(cowplot)
library(visNetwork)
```

```{r}
# Load significant pairs
significant_pairs <- read.csv("./pair stats/significant_pairs_unstrat.csv")

disease_code<-read.csv(file = "./diseaseCodes.csv")

# Load disease frequencies to help with hs_cancer_types mapping
disease_frequencies <- read.csv("./frequency tables/disease_frequencies_unstrat.csv")

# Load young adult–specific data
significant_pairs_ya <- read.csv("./pair stats/significant_pairs_young_adult.csv")
disease_frequencies_ya <- read.csv("./frequency tables/disease_frequencies_young_adult.csv")

# Load mature-specific data
significant_pairs_ma <- read.csv("./pair stats/significant_pairs_mature_adult.csv")
disease_frequencies_ma <- read.csv("./frequency tables/disease_frequencies_mature_adult.csv")

# Load senior-specific data
significant_pairs_s <- read.csv("./pair stats/significant_pairs_senior.csv")
disease_frequencies_s <- read.csv("./frequency tables/disease_frequencies_senior.csv")

all_frequencies <- c(
  disease_frequencies_ya$frequency,
  disease_frequencies_ma$frequency,
  disease_frequencies_s$frequency
)

freq_min <- min(all_frequencies, na.rm = TRUE)
freq_max <- max(all_frequencies, na.rm = TRUE)
```

```{r}
label_replacements <- c(
  "Keratoconjunctivitis sicca (KCS)" = "Keratoconjunctivitis sicca",
  "Hypertension (high blood pressure)" = "Hypertension",
  "Lameness (chronic or recurrent)" = "Lameness",
  "Bordatella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Bordetella and/or parainfluenza (kennel cough)" = "Bordatella/parainfluenza",
  "Cushing's disease (hyperadrenocorticism; excess adrenal function)" = "Cushing's disease",
  "Addison's disease (hypoadrenocorticism; low adrenal function)" = "Addison's disease",
  "Diabetes mellitus (common diabetes which causes high blood sugar)" = "Diabetes mellitus",
  "Penetrating wound (such as a stick)" = "Penetrating wound",
  "Head trauma due to any cause" = "Head trauma",
  "Chronic or recurrent cough" = "Chronic/recurrent cough",
  "Chronic or recurrent bronchitis" = "Chronic/recurrent bronchitis",
  "Tracheal stenosis (narrowing)" = "Tracheal stenosis",
  "Dental calculus (yellow build-up on teeth)" = "Dental calculus",
  "Gingivitis (red, puffy gums)" = "Gingivitis",
  "Retained deciduous (baby) teeth" = "Retained deciduous teeth",
  "Hearing loss (incompletely deaf)" = "Hearing loss",
  "Urinary tract infection (chronic or recurrent)" = "Urinary tract infection",
  "Urinary crystals or stones in bladder or urethra" = "Urinary crystals/stones",
  "Alopecia (hair loss)" = "Alopecia",
  "Atopic dermatitis (atopy)" = "Atopic dermatitis",
  "Pruritis (itchy skin)" = "Pruritis",
  "Chronic or recurrent hot spots" = "Chronic/recurrent hot spots",
  "Chronic or recurrent skin infections" = "Chronic/recurrent skin infections",
  "Food or medicine allergies that affect the skin" = "Skin food/medicine allergies",
  "Food or medicine allergies" = " Gastrointestinal food/medicine allergies",
  "Chronic or recurrent diarrhea" = "Chronic/recurrent diarrhea",
  "Chronic or recurrent vomiting" = "Chronic/recurrent vomiting",
  "Hemorrhagic gastroenteritis (HGE) or stress colitis (acute)" = "Hemorrhagic gastroenteritis or stress colitis",
  "Seborrhea or seborrheic dermatitis (greasy skin)" = "Seborrhea or seborrheic dermatitis",
  "Chocolate" = "Chocolate consumption",
  "Grapes or raisins" = "Grape/raisin consumption"
)

# Define consistent palette for all networks
fixed_categories <- c(
  "Eye", "Ear/Nose/Throat", "Mouth/Dental/Oral", "Skin", "Respiratory",
  "Gastrointestinal", "Bone/Orthopedic", "Cardiac",
  "Infection/Parasites", "Trauma", "Kidney/Urinary", "Other"
)

# Set colors
category_palette <- setNames(
  RColorBrewer::brewer.pal(length(fixed_categories), "Paired"),
  fixed_categories
)

# Override the color for "Kidney/Urinary"
category_palette["Kidney/Urinary"] <- "black"
```


```{r}
# Function to clean disease names and convert to numerical codes
clean_disease_name <- function(name) {
  if(startsWith(name, "condition_")) {
    return(sub("^condition_", "", name))
  } else if(startsWith(name, "hs_cancer_types_")) {
    code <- disease_frequencies %>%
      filter(Code.from.DAP.data == name) %>%
      pull(Numerical.Codes)
    return(if(length(code) == 0) name else as.character(code))
  }
  return(name)
}

# Format significant pairs and exclude unwanted edges (these are edges that belong to generic categories like "other skin diseases")
formatted_significant_pairs <- significant_pairs %>%
  transmute(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  ) 
```


```{r uncollapsed unstratified network}
# --- Plot uncollapsed, labeled network with disconnected component handling -----

# Build simple igraph object
raw_graph <- graph_from_data_frame(formatted_significant_pairs, directed = FALSE)

# Add node attributes
raw_categories <- disease_frequencies$Disease.Category[match(
  V(raw_graph)$name,
  as.character(disease_frequencies$Numerical.Codes)
)]
V(raw_graph)$category <- ifelse(
  raw_categories %in% fixed_categories,
  raw_categories,
  "Other"
)
V(raw_graph)$frequency <- disease_frequencies$frequency[match(
  V(raw_graph)$name,
  as.character(disease_frequencies$Numerical.Codes)
)]

# Define labels
labeled_nodes <- c("1307", "101", "102","1305", "404", "405", "412", "514", "908", "202", "911", "407", "426", "205", "104","1407")
V(raw_graph)$label <- ifelse(
  V(raw_graph)$name %in% labeled_nodes,
  disease_frequencies$Disease.Name[match(V(raw_graph)$name, as.character(disease_frequencies$Numerical.Codes))],
  NA
)
V(raw_graph)$label <- dplyr::recode(V(raw_graph)$label, !!!label_replacements)

# Edge category classification
node_cats <- V(raw_graph)$category
edge_pairs <- igraph::ends(raw_graph, E(raw_graph), names = FALSE)
edge_categories <- apply(edge_pairs, 1, function(pair) {
  cat1 <- node_cats[pair[1]]
  cat2 <- node_cats[pair[2]]
  if (cat1 == cat2) {
    if (cat1 %in% fixed_categories) cat1 else "Other"
  } else {
    "Cross-category"
  }
})
E(raw_graph)$edge_category <- edge_categories

# Build tidygraph
raw_graph_tbl <- as_tbl_graph(raw_graph)

# --- Use single KK layout for entire graph ---
coords <- layout_with_fr(raw_graph)

# Check connected components
comp <- igraph::components(raw_graph)

# Identify the largest component
main_membership <- which.max(comp$csize)

# Center main component at origin
main_nodes <- which(comp$membership == main_membership)
main_coords <- coords[main_nodes, , drop = FALSE]
center_shift <- colMeans(main_coords)
coords <- sweep(coords, 2, center_shift)  # Center layout

# Optionally: shift small disconnected components slightly if they're far out
max_dist <- 6  # threshold to shift small components closer
for (comp_id in unique(comp$membership)) {
  if (comp_id == main_membership) next
  node_ids <- which(comp$membership == comp_id)
  sub_coords <- coords[node_ids, , drop = FALSE]
  dist_from_origin <- sqrt(rowSums((sub_coords)^2))
  if (mean(dist_from_origin) > max_dist) {
    coords[node_ids, ] <- coords[node_ids, ] / 2  # pull them closer
  }
}

# Build tidygraph layout
layout_raw <- create_layout(
  raw_graph_tbl,
  layout = "manual",
  x = coords[, 1],
  y = coords[, 2]
)

# Plot
p_uncollapsed <- ggraph(layout_raw) +
  geom_edge_link(
    aes(color = edge_category),
    alpha = 0.5
  ) +
  geom_node_point(
    aes(size = frequency, color = category),
    shape = 16
  ) +
 geom_node_label(
  data = function(x) dplyr::filter(x, !is.na(label)),
  aes(label = label),
  repel = TRUE,                      # Enables repulsion
  size = 4,                        # Text size
  label.size = 0.3,                  # Border thickness around label box
  label.r = unit(0.15, "lines"),     # Rounded corners
  fill = alpha("white", 0.8),        # Background fill of label
  color = "black",                   # Font color
  box.padding = unit(0.4, "lines"),  # Space around the label
  point.padding = unit(0.15, "lines"),# Space around the node
  segment.color = "grey40",          # Connector line color
  segment.size = 0.3,                # Connector thickness
  segment.alpha = 0.7,               # Transparency
  force = 0.5,                         # Repulsion strength
  force_pull = 0.5,                  # Pull label back toward node
  max.overlaps = Inf                 # Don’t suppress any labels
) +
  scale_color_manual(
    values = c(category_palette, "Other" = "gray50", "Cross-category" = "grey38"),
    name = "Node Category"
  ) +
  scale_edge_color_manual(
    values = c(category_palette, "Other" = "gray50", "Cross-category" = "grey38"),
    name = "Edge Category"
  ) +
  scale_size_continuous(name = "Frequency", range = c(2, 8)) +
  theme_void() +
  theme(
  legend.text = element_text(size = 14),       
  legend.title = element_text(size = 16)  
)

print(p_uncollapsed)

ggsave(
  filename = "./network images/unstratified_network.png",
  plot = p_uncollapsed,
  dpi = 600,
  width = 10,
  height = 8.5,
  units = "in"
)

ggsave(
  filename = "./network images/unstratified_network.tiff",
  plot = p_uncollapsed,
  dpi = 600,
  width = 10,
  height = 8.5,
  units = "in",
  compression = "lzw"
)

cat("Number of nodes in unstratified network:", vcount(raw_graph), "\n")
```



```{r young adult network}
# Clean disease IDs
significant_pairs_ya <- significant_pairs_ya |>
  mutate(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  )

# Get unique disease codes
young_disease_ids <- unique(c(significant_pairs_ya$Disease1, significant_pairs_ya$Disease2))

# Prepare metadata
node_info_ya <- disease_code |>
  mutate(node_id = as.character(Numerical.Codes)) |>
  filter(node_id %in% young_disease_ids) |>
  dplyr::select(node_id, category = Disease.Category, disease_name = Disease.Name) |>
  left_join(
    disease_frequencies_ya |>
      mutate(node_id = as.character(Numerical.Codes)) |>
      dplyr::select(node_id, frequency),
    by = "node_id"
  ) %>%
  mutate(
    category = ifelse(category == "Toxin consumption", "Other", category)
  )

# Rebuild graph
graph_ya <- graph_from_data_frame(significant_pairs_ya, directed = FALSE)

# Reassign vertex attributes
V(graph_ya)$disease_name <- node_info_ya$disease_name[match(V(graph_ya)$name, node_info_ya$node_id)]
V(graph_ya)$category <- node_info_ya$category[match(V(graph_ya)$name, node_info_ya$node_id)]
V(graph_ya)$frequency <- node_info_ya$frequency[match(V(graph_ya)$name, node_info_ya$node_id)]

V(graph_ya)$disease_name <- dplyr::recode(
  V(graph_ya)$disease_name,
  !!!label_replacements
)

# Designate labeled nodes
labeled_nodes_ya <- c("305", "306", "412", "712", "708", "709", "1622", "1634", "423", "426", "411", "432", "1637", "1701", "1703", "405")

# Pull raw names
node_labels_ya <- disease_frequencies_ya$Disease.Name[match(
  V(graph_ya)$name,
  as.character(disease_frequencies_ya$Numerical.Codes)
)]

# Add optional recoding if you have `label_replacements` defined
node_labels_ya <- dplyr::recode(node_labels_ya, !!!label_replacements)

V(graph_ya)$label <- ifelse(
  V(graph_ya)$name %in% labeled_nodes_ya,
  node_labels_ya,
  NA
)


# Recompute edge_category_ya
node_cat_ya <- V(graph_ya)$category
edge_pairs_ya <- igraph::ends(graph_ya, E(graph_ya), names = FALSE)

edge_category_ya <- apply(edge_pairs_ya, 1, function(pair) {
  cat1 <- node_cat_ya[pair[1]]
  cat2 <- node_cat_ya[pair[2]]
  if (cat1 == cat2) cat1 else "Cross-category"
})

# Now assign safely
E(graph_ya)$edge_category <- edge_category_ya


# Convert to tidygraph and attach vertex attributes
graph_tbl_ya <- as_tbl_graph(graph_ya) |>
  activate(edges) |>
  mutate(edge_category = edge_attr(graph_ya, "edge_category")) |>
  activate(nodes) |>
  mutate(
    disease_name = V(graph_ya)$disease_name,
    frequency = V(graph_ya)$frequency,
    category = V(graph_ya)$category,
    label = V(graph_ya)$label
  )


# Use graphopt layout to automatically separate components
layout_matrix_ya <- layout_with_fr(graph_ya)

# Create manual layout for ggraph
graph_tbl_ya_layout <- create_layout(
  graph_tbl_ya,
  layout = "manual",
  x = layout_matrix_ya[, 1],
  y = layout_matrix_ya[, 2]
)

# Set palette
n_cats_ya <- length(unique(V(graph_ya)$category))
palette_ya <- brewer.pal(min(n_cats_ya, 12), "Paired")

# Plot
p_ya <- ggraph(graph_tbl_ya_layout) +
  geom_edge_link(aes(color = edge_category), alpha = 0.5) +
  geom_node_point(
  aes(size = frequency, color = category),
  shape = 16  # 17 is the shape code for an upward-pointing triangle
) +
  geom_node_label(
    aes(label = label),
    repel = TRUE,
    label.size = 0.3,
    max.overlaps = Inf,
    label.r = unit(0.15, "lines"),
    fill = alpha("white", 0.7),
    color = "black",
    size = 4
  ) +
  scale_color_manual(
  values = category_palette,
  breaks = sort(names(category_palette)),
  name = "Node Category"
) +
  scale_edge_color_manual(
  values = c(category_palette, "Cross-category" = "grey38"),
  breaks = c(sort(names(category_palette)), "Cross-category"),
  name = "Edge Category"
) +
  scale_size_continuous(
  name = "Frequency",
  limits = c(freq_min, freq_max),
  range = c(5, 12),
  breaks = c(500, 1000, 2000, 5000, 10000)  # adjust as fits your data
) +
  theme_void() +
  theme(
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14)
  )

print(p_ya)

# Save plot
ggsave(
  filename = "./network images/young_adult_network_graph.png",
  plot = p_ya,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)
cat("Number of nodes in young adult network:", vcount(graph_ya), "\n")
```


```{r}
# --- Mature Adult Network: Uncollapsed, Unlabeled ----------------------------

# Clean and filter significant pairs
raw_pairs_ma <- significant_pairs_ma |>
  mutate(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  ) 

# Build graph
raw_graph_ma <- graph_from_data_frame(raw_pairs_ma, directed = FALSE)

# Assign categories
raw_categories_ma <- disease_frequencies_ma$Disease.Category[
  match(V(raw_graph_ma)$name, as.character(disease_frequencies_ma$Numerical.Codes))
]

# Standardize categories to match palette
V(raw_graph_ma)$display_category <- ifelse(
  raw_categories_ma %in% fixed_categories,
  raw_categories_ma,
  "Other"
)

# Match frequency
V(raw_graph_ma)$frequency <- disease_frequencies_ma$frequency[
  match(V(raw_graph_ma)$name, as.character(disease_frequencies_ma$Numerical.Codes))
]

# Designate labeled nodes
labeled_nodes_ma <- c("101","102","305", "306", "412", "712", "708", "709", "1622", "1634", "423", "426", "411", "432", "1637", "1701", "1703", "405")



# Pull raw names
node_labels_ma <- disease_frequencies_ma$Disease.Name[match(
  V(raw_graph_ma)$name,
  as.character(disease_frequencies_ma$Numerical.Codes)
)]

# Add optional recoding if you have `label_replacements` defined
node_labels_ma <- dplyr::recode(node_labels_ma, !!!label_replacements)

# Assign labels only to selected nodes
V(raw_graph_ma)$label <- ifelse(
  V(raw_graph_ma)$name %in% labeled_nodes_ma,
  node_labels_ma,
  NA
)

# Compute edge category
edge_pairs_ma <- igraph::ends(raw_graph_ma, E(raw_graph_ma), names = FALSE)
edge_categories_ma <- apply(edge_pairs_ma, 1, function(pair) {
  cat1 <- V(raw_graph_ma)$display_category[pair[1]]
  cat2 <- V(raw_graph_ma)$display_category[pair[2]]
  if (cat1 == cat2) cat1 else "Cross-category"
})
E(raw_graph_ma)$edge_category <- edge_categories_ma

# Layout
layout_matrix_ma_uncollapsed <- layout_with_fr(raw_graph_ma)

# Convert to tidygraph
graph_tbl_ma_uncollapsed <- as_tbl_graph(raw_graph_ma) |>
  activate(nodes) |>
  mutate(
    frequency = V(raw_graph_ma)$frequency,
    display_category = V(raw_graph_ma)$display_category,
    label = V(raw_graph_ma)$label
  ) |>
  activate(edges) |>
  mutate(edge_category = E(raw_graph_ma)$edge_category)

graph_tbl_ma_layout_uncollapsed <- create_layout(
  graph_tbl_ma_uncollapsed,
  layout = "manual",
  x = layout_matrix_ma_uncollapsed[, 1],
  y = layout_matrix_ma_uncollapsed[, 2]
)

# Plot (no collapsing, no labels)
p_ma_uncollapsed <- ggraph(graph_tbl_ma_layout_uncollapsed) +
  geom_edge_link(aes(color = edge_category), alpha = 0.5) +
  geom_node_point(
    aes(size = frequency, color = display_category),
    shape = 16  # triangle shape
  ) +
  scale_color_manual(
  values = category_palette,
  breaks = sort(names(category_palette)),
  name = "Node Category"
) +
  geom_node_label(
  aes(label = label),
  na.rm = TRUE,
  repel = TRUE,
  label.size = 0.3,
  max.overlaps = Inf,
  label.r = unit(0.15, "lines"),
  fill = alpha("white", 0.7),
  color = "black",
  size = 4
)+
  scale_edge_color_manual(
  values = c(category_palette, "Cross-category" = "grey38"),
  breaks = c(sort(names(category_palette)), "Cross-category"),
  name = "Edge Category"
) +
  scale_size_continuous(
    name = "Frequency",
    limits = c(freq_min, freq_max),
    range = c(5, 12),
    breaks = c(500, 1000, 2000, 5000, 10000)
  ) +
  theme_void()

print(p_ma_uncollapsed)

# Save
ggsave(
  filename = "./network images/mature_adult_network_graph_uncollapsed_nolabels.png",
  plot = p_ma_uncollapsed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)

cat("Number of nodes in mature_adult network:", vcount(raw_graph_ma), "\n")

```

```{r}
# --- Senior Network: Uncollapsed, Unlabeled ----------------------------------

# Clean disease IDs
raw_pairs_s <- significant_pairs_s |>
  mutate(
    Disease1 = map_chr(Disease1, clean_disease_name),
    Disease2 = map_chr(Disease2, clean_disease_name)
  )

# Build graph
raw_graph_s <- graph_from_data_frame(raw_pairs_s, directed = FALSE)

# Assign categories
raw_categories_s <- disease_frequencies_s$Disease.Category[
  match(V(raw_graph_s)$name, as.character(disease_frequencies_s$Numerical.Codes))
]

# Standardize to fixed palette or "Other"
V(raw_graph_s)$display_category <- ifelse(
  raw_categories_s %in% fixed_categories,
  raw_categories_s,
  "Other"
)

# Designate labeled nodes
labeled_nodes_s <- c("101","102","908", "514", "305", "306", "412", "712", "708", "709", "1622", "1634", "405", "423", "426", "411", "432", "1637", "426", "1701", "1703", "405")



# Pull raw names
node_labels_s <- disease_frequencies_s$Disease.Name[match(
  V(raw_graph_s)$name,
  as.character(disease_frequencies_s$Numerical.Codes)
)]

# Add optional recoding if you have `label_replacements` defined
node_labels_s <- dplyr::recode(node_labels_s, !!!label_replacements)

# Assign labels only to selected nodes
V(raw_graph_s)$label <- ifelse(
  V(raw_graph_s)$name %in% labeled_nodes_s,
  node_labels_s,
  NA
)


# Assign frequencies
V(raw_graph_s)$frequency <- disease_frequencies_s$frequency[
  match(V(raw_graph_s)$name, as.character(disease_frequencies_s$Numerical.Codes))
]

# Compute edge categories
edge_pairs_s <- igraph::ends(raw_graph_s, E(raw_graph_s), names = FALSE)
edge_categories_s <- apply(edge_pairs_s, 1, function(pair) {
  cat1 <- V(raw_graph_s)$display_category[pair[1]]
  cat2 <- V(raw_graph_s)$display_category[pair[2]]
  if (cat1 == cat2) cat1 else "Cross-category"
})
E(raw_graph_s)$edge_category <- edge_categories_s

# Layout using Kamada-Kawai (can switch to layout_with_fr if preferred)
layout_matrix_s_uncollapsed <- layout_with_fr(raw_graph_s)

# Convert to tidygraph and attach attributes
graph_tbl_s_uncollapsed <- as_tbl_graph(raw_graph_s) |>
  activate(nodes) |>
  mutate(
    frequency = V(raw_graph_s)$frequency,
    display_category = V(raw_graph_s)$display_category,
    label = V(raw_graph_s)$label
  ) |>
  activate(edges) |>
  mutate(edge_category = E(raw_graph_s)$edge_category)

graph_tbl_s_layout_uncollapsed <- create_layout(
  graph_tbl_s_uncollapsed,
  layout = "manual",
  x = layout_matrix_s_uncollapsed[, 1],
  y = layout_matrix_s_uncollapsed[, 2]
)

# Prepare alphabetically sorted palette
sorted_cats_s <- sort(names(category_palette))
edge_palette_s <- c(category_palette, "Cross-category" = "grey38")

# Plot
p_s_uncollapsed <- ggraph(graph_tbl_s_layout_uncollapsed) +
  geom_edge_link(aes(color = edge_category), alpha = 0.5) +
  geom_node_point(
    aes(size = frequency, color = display_category),
    shape = 16  # Triangle
  ) +
  scale_color_manual(
    values = category_palette,
    breaks = sorted_cats_s,
    name = "Node Category"
  ) +
  geom_node_label(
  aes(label = label),
  na.rm = TRUE,
  repel = TRUE,
  label.size = 0.3,
  max.overlaps = Inf,
  label.r = unit(0.15, "lines"),
  fill = alpha("white", 0.7),
  color = "black",
  size = 4
)+
  scale_edge_color_manual(
    values = c(category_palette, "Cross-category" = "grey38"),
    breaks = c(sorted_cats_s, "Cross-category"),
    name = "Edge Category"
  ) +
  scale_size_continuous(
    name = "Frequency",
    limits = c(freq_min, freq_max),
    range = c(5, 12),
    breaks = c(500, 1000, 2000, 5000, 10000)
  ) +
  theme_void() +
  theme(
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 14)
  )

print(p_s_uncollapsed)

# Save
ggsave(
  filename = "./network images/senior_network_graph_uncollapsed_nolabels.png",
  plot = p_s_uncollapsed,
  dpi = 600,
  width = 10,
  height = 8,
  units = "in"
)

cat("Number of nodes in senior network:", vcount(raw_graph_s), "\n")


```

```{r age strata heatmap}
# Network data files - pairs of comorbid conditions from different age strata
senior_pairs <- read.csv("./pair stats/significant_pairs_senior.csv", stringsAsFactors=FALSE) %>%
  mutate(age_group = "senior")
mature_adult_pairs <- read.csv("./pair stats/significant_pairs_mature_adult.csv", stringsAsFactors=FALSE) %>%
  mutate(age_group = "mature_adult")
young_adult_pairs <- read.csv("./pair stats/significant_pairs_young_adult.csv", stringsAsFactors=FALSE) %>%
  mutate(age_group = "young_adult")
puppy_pairs <- read.csv("./pair stats/significant_pairs_puppy.csv", stringsAsFactors=FALSE) %>%
  mutate(age_group = "puppy")
unstrat_pairs <- read.csv("./pair stats/significant_pairs_unstrat.csv", stringsAsFactors=FALSE) %>%
  mutate(age_group = "unstratified")

# Function to process dataframe and create standardized edge IDs
# This ensures consistent comparison across networks
process_pairs <- function(df) {
  df %>%
    dplyr::select(Disease1, Disease2) %>%
    rowwise() %>%
    mutate(
      sorted_pair = paste(sort(c(Disease1, Disease2)), collapse = "-")
    ) %>%
    ungroup() %>%
    pull(sorted_pair)
}

# Process each dataset to extract edge information
senior_edges <- process_pairs(senior_pairs)
mature_edges <- process_pairs(mature_adult_pairs)
young_edges <- process_pairs(young_adult_pairs)
puppy_edges <- process_pairs(puppy_pairs)
unstrat_edges <- process_pairs(unstrat_pairs)

# Create named list of all edge sets
all_edge_sets <- list(
  unstratified = unstrat_edges,
  puppy = puppy_edges,
  young_adult = young_edges,
  mature_adult = mature_edges,
  senior = senior_edges
)

# Create overlap matrix to quantify shared edges between networks
n_sets <- length(all_edge_sets)
overlap_matrix <- matrix(0, nrow = n_sets, ncol = n_sets)
rownames(overlap_matrix) <- colnames(overlap_matrix) <- names(all_edge_sets)

# Calculate overlaps - pairwise comparisons of edge sets
for(i in 1:n_sets) {
  for(j in i:n_sets) {
    overlap <- length(intersect(all_edge_sets[[i]], all_edge_sets[[j]]))
    overlap_matrix[i,j] <- overlap
    overlap_matrix[j,i] <- overlap
  }
}

# Convert the overlap matrix to long-form dataframe
overlap_df <- as.data.frame(as.table(overlap_matrix))
colnames(overlap_df) <- c("category", "comparison", "shared_edges")

# Define order for visualization
desired_order <- c("unstratified", "puppy", "young_adult", "mature_adult", "senior")

# Convert matrix to long format for plotting
# Filter to only plot lower triangle + diagonal (optional, for aesthetics)
overlap_df_plot <- overlap_df %>%
  mutate(
    category = factor(category, levels = desired_order),
    comparison = factor(comparison, levels = desired_order)
  ) %>%
  filter(as.numeric(category) <= as.numeric(comparison))


# Set the desired order (without dummy space)
desired_order <- c("unstratified", "puppy", "young_adult", "mature_adult", "senior")

p_other_clean <- ggplot(overlap_df_plot, aes(x = category, y = comparison, fill = shared_edges)) +
  geom_tile(color = "black", linewidth = 0.5) +
  geom_text(aes(label = shared_edges), color = "black", size = 6) +
  scale_fill_gradient(low = "#ffffff", high = "#00abc8") +
  theme_minimal() +
  labs(fill = "Shared Edges") +
  theme(
    axis.text.x.top = element_text(angle = 45, hjust = 0, size = 18),
    axis.text.y = element_text(hjust = 1, size = 18),
    axis.title = element_blank(),
    axis.ticks.x.top = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.ticks.y = element_blank(),
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 18),
    panel.grid = element_blank(),
    aspect.ratio = 1
  ) +
  scale_x_discrete(
    limits = desired_order,
    position = "top",
    labels = c("unstratified", "puppy", "young adult", "mature adult", "senior")
  ) +
  scale_y_discrete(
    limits = rev(desired_order),
    labels = rev(c("unstratified", "puppy", "young adult", "mature adult", "senior"))
  ) +
  coord_fixed()

p_other_clean
```



```{r}
# Extract legend from p_ma_uncollapsed
legend_ma <- get_legend(
  p_ma_uncollapsed + 
    theme(legend.position = "right", legend.title = element_text(size = 16), legend.text = element_text(size = 14))
)

# Suppress legends for plots that will go in the grid
p_ya_clean <- p_ya + theme(legend.position = "none", 
                           plot.margin = margin(r=20, b=20))
p_ma_clean <- p_ma_uncollapsed + theme(legend.position = "none",
                                       plot.margin = margin(l=20, b=20))
p_s_clean <- p_s_uncollapsed + theme(legend.position = "none",
                                     plot.margin = margin(r=20, t=20))
p_other_clean <- p_other_clean + theme(legend.position = "none",
                                       plot.margin = margin(l=20, t=20))

# Add labels to the cleaned plots
p_ya_labeled <- ggdraw(p_ya_clean) + 
  draw_label("a)", x = 0.02, y = 0.98, hjust = 0, vjust = 1, fontface = "bold", size = 28)

p_ma_labeled <- ggdraw(p_ma_clean) + 
  draw_label("b)", x = 0.02, y = 0.98, hjust = 0, vjust = 1, fontface = "bold", size = 28)

p_s_labeled <- ggdraw(p_s_clean) + 
  draw_label("c)", x = 0.02, y = 0.98, hjust = 0, vjust = 1, fontface = "bold", size = 28)

p_other_labeled <- ggdraw(p_other_clean) + 
  draw_label("d)", x = 0.02, y = 0.98, hjust = 0, vjust = 1, fontface = "bold", size = 28)

# Arrange 2x2 grid without legend
main_grid <- plot_grid(
  plot_grid(p_ya_labeled, p_ma_labeled, ncol = 2),
  plot_grid(p_s_labeled, p_other_labeled, ncol = 2),
  ncol = 1
)

# Add the shared legend
final_plot <- plot_grid(
  legend_ma,
  main_grid,
  rel_widths = c(0.15, 0.85)
)

# Save
ggsave(
  filename = "./network images/combined_2x2_with_heatmap_cowplot_legend.png",
  plot = final_plot,
  dpi = 600,
  width = 20,
  height = 18,
  units = "in"
)

ggsave(
  filename = "./network images/combined_2x2_with_heatmap_cowplot_legend.tiff",
  plot = final_plot,
  dpi = 600,
  width = 20,
  height = 18,
  units = "in",
  compression = "lzw"
)

final_plot
```



